<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Comunica√ß√£o entre processos</title>
        <link rel="stylesheet" href="../style/style.css" />
        <style>
            .log-entry.switch {
                border-left-color: #ff9800;
                background-color: #fff3e0;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <h1>Comunica√ß√£o entre processos</h1>
        <h4>Sistema Integrado de IPC</h4>

        <div class="main-container">
            <div class="form-container">
                <label for="tipo-comunicacao">Tipo de comunica√ß√£o:</label>
                <select id="tipo-comunicacao">
                    <option value="pipes">Pipes An√¥nimos</option>
                    <option value="socket">Sockets Locais</option>
                    <option value="memcomp">Mem√≥ria Compartilhada</option>
                </select>

                <label for="enviar-msg">Enviar mensagem:</label>
                <textarea
                    id="enviar-msg"
                    rows="3"
                    placeholder="Digite sua mensagem aqui..."
                ></textarea>

                <button id="btn-enviar" type="button">Enviar Mensagem</button>

                <label for="receber-msg">Mensagem recebida:</label>
                <textarea
                    id="receber-msg"
                    rows="3"
                    readonly
                    placeholder="A mensagem recebida aparecer√° aqui..."
                ></textarea>
            </div>

            <div class="log-container">
                <label for="log-display">Log da Comunica√ß√£o:</label>
                <div id="log-display" class="log-content">
                    <div class="log-entry info">
                        Sistema iniciado. Aguardando mensagens...
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Mapeamento de tipos de comunica√ß√£o para nomes de processos
            const processNames = {
                pipes: { sender: "Processo1", receiver: "Processo2" },
                socket: { sender: "Cliente", receiver: "Servidor" },
                memcomp: { sender: "Escritor", receiver: "Leitor" },
            };

            // Mapeamento de tipos de comunica√ß√£o para descri√ß√µes
            const commDescriptions = {
                pipes: "Pipes An√¥nimos",
                socket: "Sockets Locais",
                memcomp: "Mem√≥ria Compartilhada",
            };

            document.getElementById("btn-enviar").onclick = async function () {
                const mensagem = document.getElementById("enviar-msg").value;
                const tipo = document.getElementById("tipo-comunicacao").value;

                if (!mensagem.trim()) {
                    addLogEntry(
                        "‚ùå Erro: Digite uma mensagem para enviar",
                        "error"
                    );
                    return;
                }

                if (!processNames[tipo]) {
                    addLogEntry(
                        "‚ùå Erro: Selecione um tipo de comunica√ß√£o v√°lido",
                        "error"
                    );
                    return;
                }

                const { sender, receiver } = processNames[tipo];
                const commType = commDescriptions[tipo];

                document.getElementById("receber-msg").value = "Enviando...";
                addLogEntry(
                    `üì§ ${sender} enviando: "${mensagem}" via ${commType}`,
                    "info"
                );

                try {
                    const resp = await fetch("/enviar", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ mensagem, tipo }),
                    });

                    const data = await resp.json();

                    if (data.status === "sucesso") {
                        document.getElementById("receber-msg").value =
                            data.mensagem_recebida ||
                            data.mensagem ||
                            "Mensagem recebida";

                        // Mensagem personalizada para cada tipo de comunica√ß√£o
                        let successMessage;
                        if (tipo === "pipes") {
                            successMessage = `‚úÖ Sucesso via Pipes: ${sender} enviou: "${data.mensagem_enviada}", ${receiver} recebeu: "${data.mensagem_recebida}"`;
                        } else if (tipo === "socket") {
                            successMessage = `‚úÖ Sucesso via Sockets: ${sender} enviou: "${data.mensagem_enviada}", ${receiver} recebeu: "${data.mensagem_recebida}"`;
                        } else if (tipo === "memcomp") {
                            successMessage = `‚úÖ Sucesso via Mem√≥ria Compartilhada: ${sender} escreveu: "${data.mensagem_enviada}", ${receiver} leu: "${data.mensagem_recebida}"`;
                        }

                        addLogEntry(successMessage, "success");
                    } else {
                        document.getElementById("receber-msg").value =
                            "Erro ao receber mensagem";
                        addLogEntry(
                            `‚ùå Erro na comunica√ß√£o via ${
                                commDescriptions[tipo]
                            }: ${data.mensagem || "Erro desconhecido"}`,
                            "error"
                        );
                    }
                } catch (error) {
                    document.getElementById("receber-msg").value =
                        "Erro de conex√£o";
                    addLogEntry(
                        `‚ùå Erro de conex√£o com o servidor: ${error.message}`,
                        "error"
                    );
                }
            };

            function addLogEntry(message, type = "info") {
                const logDisplay = document.getElementById("log-display");
                const logEntry = document.createElement("div");
                logEntry.className = `log-entry ${type}`;

                // Adiciona timestamp com milissegundos
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, "0");
                const minutes = now.getMinutes().toString().padStart(2, "0");
                const seconds = now.getSeconds().toString().padStart(2, "0");
                const milliseconds = now
                    .getMilliseconds()
                    .toString()
                    .padStart(3, "0");

                logEntry.textContent = `[${hours}:${minutes}:${seconds}.${milliseconds}] ${message}`;
                logDisplay.prepend(logEntry);

                // Mant√©m apenas as √∫ltimas 20 entradas no log
                if (logDisplay.children.length > 20) {
                    logDisplay.removeChild(logDisplay.lastChild);
                }

                // Scroll autom√°tico para o topo
                logDisplay.scrollTop = 0;
            }

            // Limpar mensagem e processos ao trocar de tipo de comunica√ß√£o
            document
                .getElementById("tipo-comunicacao")
                .addEventListener("change", async function () {
                    const tipoAnterior =
                        this.getAttribute("data-tipo-anterior") || "pipes";
                    const novoTipo = this.value;

                    // Limpar campos de texto
                    document.getElementById("enviar-msg").value = "";
                    document.getElementById("receber-msg").value = "";

                    // Finalizar processos do tipo anterior
                    try {
                        await fetch("/limpar", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ tipo: tipoAnterior }),
                        });
                    } catch (error) {
                        console.log("Erro ao limpar processos:", error);
                    }

                    // Atualizar tipo anterior
                    this.setAttribute("data-tipo-anterior", novoTipo);

                    const { sender, receiver } = processNames[novoTipo] || {};
                    const commType = commDescriptions[novoTipo];

                    if (sender && receiver) {
                        addLogEntry(
                            `üîÑ Alterado para: ${commType} (${sender} ‚Üí ${receiver}) - Processos anteriores finalizados`,
                            "switch"
                        );
                    }
                });

            // Inicializar com pipes como tipo anterior
            document
                .getElementById("tipo-comunicacao")
                .setAttribute("data-tipo-anterior", "pipes");

            // Inicializa o log com mensagem informativa
            addLogEntry(
                "Sistema integrado de IPC iniciado. Selecione o tipo de comunica√ß√£o.",
                "info"
            );
        </script>
    </body>
</html>
